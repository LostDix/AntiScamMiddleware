# AntiScamMiddleware | –ó–∞—â–∏—Ç–∞ Telegram-—á–∞—Ç–æ–≤ –æ—Ç –º–æ—à–µ–Ω–Ω–∏–∫–æ–≤
–≠—Ç–æ—Ç middleware –ø–æ–º–æ–≥–∞–µ—Ç –∑–∞—â–∏—Ç–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–∞—Ç–∞ –æ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –º–æ—à–µ–Ω–Ω–∏–∫–æ–≤, —Ä–µ–≥—É–ª—è—Ä–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞—è –æ –º–µ—Ä–∞—Ö –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä—ë–º –µ–≥–æ —Ä–∞–±–æ—Ç—É –ø–æ–¥—Ä–æ–±–Ω–æ.
<br>
[–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –¢–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç–æ–≤](https://else.com.ru "–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –¢–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç–æ–≤") -> https://else.com.ru/

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞
`AntiScamMiddleware` –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≤–∞–∂–Ω—É—é –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏—á–µ—Å–∫—É—é —Ñ—É–Ω–∫—Ü–∏—é:

<ol> 
    <li>–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ —á–∞—Ç–µ</li> 
    <li>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–µ</li> 
    <li>–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç —á–∞—Å—Ç–æ—Ç—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</li> 
    <li>–ù–µ –º–µ—à–∞–µ—Ç –æ–±—ã—á–Ω–æ–º—É –æ–±—â–µ–Ω–∏—é</li> 
</ol>
    
## –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
```
  WARNING_TEXT = """
  ‚ö†Ô∏è <b>–í–Ω–∏–º–∞–Ω–∏–µ! –£—á–∞—Å—Ç–∏–ª–∏—Å—å —Å–ª—É—á–∞–∏ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞!</b>

  –î–æ—Ä–æ–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –±—É–¥—å—Ç–µ –±–¥–∏—Ç–µ–ª—å–Ω—ã! –í –ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è —É—á–∞—Å—Ç–∏–ª–∏—Å—å –ø–æ–ø—ã—Ç–∫–∏ –æ–±–º–∞–Ω–∞.
  üîπ –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –Ω–µ–∑–Ω–∞–∫–æ–º—ã–º –ª—é–¥—è–º!
  üîπ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –ù–ï –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–µ—Ä–µ–≤–æ–¥—ã.
  üîπ –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏ –Ω–µ –¥–æ–≤–µ—Ä—è–π—Ç–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º.

  –ë–µ—Ä–µ–≥–∏—Ç–µ —Å–µ–±—è –∏ —Å–≤–æ–∏ —Ñ–∏–Ω–∞–Ω—Å—ã!
  """
```


+ HTML-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</li>
+ –ß—ë—Ç–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</li>
+ –ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</li>

## –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
```
  def __init__(self, bot):
    self.bot = bot
    self.last_warning_time = {}  # {chat_id: last_warning_datetime}
    self.message_counters = defaultdict(int)  # {chat_id: message_count}
    super().__init__()
    logger.info("Initialized AntiScamMiddleware")
```
+ `bot` - —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</li>
+ `last_warning_time` - –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞—Ç–∞</li>
+ `message_counters` - —Å—á—ë—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–∞—Ö</li>

## –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã
1. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
```
  message = event.message or event.edited_message
  if not message:
    return await handler(event, data)

  if self._is_service_message(message):
    return await handler(event, data)

  chat_id = message.chat.id
```
+ –†–∞–±–æ—Ç–∞–µ—Ç —Å –æ–±—ã—á–Ω—ã–º–∏ –∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏</li>
+ –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —Å–ª—É–∂–µ–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</li>
+ –ü–æ–ª—É—á–∞–µ—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —á–∞—Ç–∞</li>

2. –£—á—ë—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
```
  self.message_counters[chat_id] += 1

  if not message.reply_to_message and await self._check_general_warning(message):
    await self._send_warning(message)
    self.last_warning_time[chat_id] = datetime.now()
    self.message_counters[chat_id] = 0
```
+ –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π</li>
+ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Å–ª–æ–≤–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è</li>
+ –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏</li>

## –ú–µ—Ç–æ–¥—ã –ø—Ä–æ–≤–µ—Ä–æ–∫
–£—Å–ª–æ–≤–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
```
  async def _check_general_warning(self, message: Message) -> bool:
    chat_id = message.chat.id

    if chat_id not in self.last_warning_time:
        return True

    if (datetime.now() - self.last_warning_time[chat_id]) < timedelta(hours=3):
        return False

    return self.message_counters[chat_id] >= 50
```
+ –ü–µ—Ä–≤–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ - —Å—Ä–∞–∑—É</li>
+ –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ - –Ω–µ —á–∞—â–µ —á–µ–º —Ä–∞–∑ –≤ 3 —á–∞—Å–∞</li>
+ –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ 50+ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ</li>

–û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
```
  async def _send_warning(self, message: Message):
    try:
        await self.bot.send_message(
            chat_id=message.chat.id,
            text=WARNING_TEXT,
            parse_mode="HTML"
        )
        logger.info(f"Sent scam warning to chat {message.chat.id}")
    except Exception as e:
        logger.error(f"Failed to send warning message: {e}")
```
+ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç HTML-—Ä–∞–∑–º–µ—Ç–∫—É</li>
+ –õ–æ–≥–∏—Ä—É–µ—Ç —É—Å–ø–µ—à–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É</li>
+ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏</li>

## –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
–≠—Ç–æ—Ç middleware –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ–ª–µ–∑–µ–Ω –¥–ª—è:

+ –§–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —á–∞—Ç–æ–≤ –∏ –∫–∞–Ω–∞–ª–æ–≤
+ –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ—Å—Ç–≤
+ –¢–æ—Ä–≥–æ–≤—ã—Ö –ø–ª–æ—â–∞–¥–æ–∫
+ –ß–∞—Ç–æ–≤ —Å –≤—ã—Å–æ–∫–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é
+ –õ—é–±—ã—Ö –≥—Ä—É–ø–ø, –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω—ã —Å–ª—É—á–∞–∏ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞


## –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è
–í—ã –º–æ–∂–µ—Ç–µ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å middleware –ø–æ–¥ —Å–≤–æ–∏ –Ω—É–∂–¥—ã:

<ol>
    <li>–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è</li>
    <li>–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã</li>
    <li>–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤</li>
    <li>–í–≤–µ—Å—Ç–∏ —Ä–∞–∑–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π</li>
</ol>

```
  # –ü—Ä–∏–º–µ—Ä –∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤
  def __init__(self, bot):
    self.warning_interval = timedelta(hours=1)  # –≤–º–µ—Å—Ç–æ 3 —á–∞—Å–æ–≤
    self.message_threshold = 30  # –≤–º–µ—Å—Ç–æ 50 —Å–æ–æ–±—â–µ–Ω–∏–π
    ...
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ
AntiScamMiddleware - —ç—Ç–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∏ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞ –≤ Telegram-—á–∞—Ç–∞—Ö, –∫–æ—Ç–æ—Ä–æ–µ –Ω–µ–Ω–∞–≤—è–∑—á–∏–≤–æ –Ω–∞–ø–æ–º–∏–Ω–∞–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
<br>
<blockquote>
<b>–•–æ—Ç–∏—Ç–µ –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é –∑–∞—â–∏—Ç—É –æ—Ç –º–æ—à–µ–Ω–Ω–∏–∫–æ–≤ –≤ –≤–∞—à–µ–º —á–∞—Ç–µ?</b>

–ö–æ–º–∞–Ω–¥–∞ ELSE (https://else.com.ru/) —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Å–∏—Å—Ç–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:<br>

‚úÖ –ó–∞—â–∏—Ç—É –æ—Ç —Å–ø–∞–º–∞ (–∫–∞–∫ –≤ —ç—Ç–æ–º –ø—Ä–∏–º–µ—Ä–µ)<br>
‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å API, –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö –∏ –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏<br>
‚úÖ –ö–∞—Å—Ç–æ–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è<br>
‚úÖ –ë—ã—Å—Ç—Ä—É—é –∏ —Å—Ç–∞–±–∏–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É<br>

–ó–∞–∫–∞–∂–∏—Ç–µ –∑–∞—â–∏—â—ë–Ω–Ω—ã–π —á–∞—Ç –Ω–∞ else.com.ru –∏ –æ–±—â–∞–π—Ç–µ—Å—å –±–µ–∑–æ–ø–∞—Å–Ω–æ!<br>
[–°–æ–∑–¥–∞–Ω–∏–µ –¢–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç–æ–≤](https://else.com.ru "–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –¢–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç–æ–≤") -> https://else.com.ru/
</blockquote>
    

    
